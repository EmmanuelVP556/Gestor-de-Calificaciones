<!DOCTYPE html>
<html lang="es" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Calificaciones</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configuración de Tailwind para Modo Oscuro -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: { 
                            bg: '#0f172a', 
                            card: '#1e293b', 
                            text: '#f8fafc',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos base */
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Ocultar flechas de input number */
        .grade-input::-webkit-outer-spin-button,
        .grade-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .grade-input { -moz-appearance: textfield; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos específicos para SweetAlert en modo oscuro */
        .dark .swal2-popup { background: #1e293b; color: #f8fafc; }
        .dark .swal2-title, .dark .swal2-content { color: #f8fafc; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text min-h-screen flex flex-col transition-colors duration-300">

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[60] bg-slate-50 dark:bg-dark-bg flex items-center justify-center p-4 hidden">
        <div class="max-w-md w-full bg-white dark:bg-dark-card p-8 rounded-2xl shadow-xl text-center border border-slate-100 dark:border-dark-border">
            <div class="bg-indigo-100 dark:bg-indigo-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 dark:text-indigo-400">
                <i data-lucide="lock" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Bienvenido</h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8">Inicia sesión para sincronizar tus calificaciones.</p>
            
            <button onclick="loginWithGoogle()" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 text-slate-700 dark:text-white font-medium py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition-all shadow-sm group mb-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span class="group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">Continuar con Google</span>
            </button>
            
            <!-- Opción de respaldo: Invitado -->
            <button onclick="loginGuest()" class="w-full text-sm text-slate-400 hover:text-indigo-500 transition-colors py-2">
                O continuar como Invitado (Solo en este dispositivo)
            </button>

            <p class="mt-6 text-xs text-slate-400">Si Google falla, usa el modo Invitado.</p>
        </div>
    </div>

    <!-- HEADER DE LA APP -->
    <header class="bg-indigo-600 dark:bg-indigo-900 text-white shadow-lg sticky top-0 z-40 transition-colors duration-300">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                    <i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Gestor de Calificaciones</h1>
                    <p class="text-xs text-indigo-200">v5</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Botón Dark Mode -->
                <button onclick="toggleDarkMode()" class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition text-indigo-100" title="Cambiar Tema">
                    <i data-lucide="moon" id="theme-icon" class="w-5 h-5"></i>
                </button>
                
                <!-- Botón Exportar -->
                <button onclick="exportToImage()" class="hidden md:flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-500/90 hover:bg-emerald-500 text-white text-sm font-medium transition shadow-lg shadow-emerald-900/20">
                    <i data-lucide="camera" class="w-4 h-4"></i>
                    <span>Foto</span>
                </button>

                <!-- Perfil / Logout -->
                <div class="relative group">
                    <button id="user-avatar-btn" class="w-9 h-9 rounded-full bg-indigo-400 border-2 border-indigo-300 overflow-hidden focus:outline-none">
                        <!-- La imagen se carga via JS -->
                        <img id="user-avatar" src="" alt="User" class="w-full h-full object-cover hidden">
                        <span id="user-initial" class="w-full h-full flex items-center justify-center font-bold text-sm">?</span>
                    </button>
                    <!-- Dropdown -->
                    <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-card rounded-xl shadow-xl border border-slate-100 dark:border-dark-border py-1 hidden group-hover:block fade-in">
                        <div class="px-4 py-2 border-b border-slate-100 dark:border-dark-border">
                            <p class="text-xs text-slate-400">Sesión iniciada como</p>
                            <p id="user-name-display" class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate">Usuario</p>
                        </div>
                        <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="max-w-5xl mx-auto px-4 py-8 flex-1 w-full">

        <!-- Barra de Promedio Semestral (Estilo Tarjeta Grande) -->
        <div id="capture-area-header" class="bg-white dark:bg-dark-card rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-dark-border mb-8 flex flex-col md:flex-row items-center justify-between gap-6 transition-colors duration-300">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-1">Resumen General</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Mantén tus promedios en verde para evitar problemas.</p>
            </div>
            
            <div class="flex items-center gap-6 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                <div class="text-right hidden sm:block">
                    <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Promedio Semestral</div>
                    <div id="semester-status" class="text-sm font-medium text-emerald-600">Excelente</div>
                </div>
                <div class="relative w-20 h-20 flex items-center justify-center">
                    <!-- Círculo de fondo -->
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="40" cy="40" r="36" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-200 dark:text-slate-700" />
                        <circle id="sem-circle" cx="40" cy="40" r="36" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="226" stroke-dashoffset="226" class="text-indigo-600 transition-all duration-1000 ease-out" />
                    </svg>
                    <span id="semester-average" class="absolute text-2xl font-bold text-slate-800 dark:text-white">--</span>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="flex flex-wrap gap-3 mb-6">
            <button onclick="addNewSubject()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition shadow-lg shadow-indigo-200 dark:shadow-none text-sm font-medium">
                <i data-lucide="plus" class="w-4 h-4"></i> Nueva Materia
            </button>
            <button onclick="window.clearAllData()" class="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 px-5 py-2.5 rounded-xl flex items-center gap-2 transition text-sm font-medium">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Limpiar Todo
            </button>
            <!-- Botón Exportar visible en móvil -->
            <button onclick="exportToImage()" class="md:hidden ml-auto bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-medium">
                <i data-lucide="camera" class="w-4 h-4"></i> Foto
            </button>
        </div>

        <!-- GRID DE MATERIAS -->
        <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-12">
            <!-- Spinner de carga -->
            <div class="col-span-full flex flex-col items-center justify-center py-20 opacity-50">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mb-4"></div>
                <p class="text-sm text-slate-400">Cargando tus materias...</p>
            </div>
        </div>

    </main>

    <!-- FIREBASE & LÓGICA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // IMPORTANTE: Agregamos signInAnonymously de nuevo como respaldo
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------------
        // 1. TUS CREDENCIALES AQUÍ (ASEGÚRATE DE QUE ESTÉN BIEN COPIADAS)
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAEmGBy3_aFKUmGq135hTdcizemD36htG4",
            authDomain: "gestor-calificaciones-5acbc.firebaseapp.com",
            projectId: "gestor-calificaciones-5acbc",
            storageBucket: "gestor-calificaciones-5acbc.firebasestorage.app",
            messagingSenderId: "51527525576",
            appId: "1:51527525576:web:6e7dbbf38f178f059031fd"
        };
        // -----------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = 'mi-gestor-pro-v3';

        let currentUser = null;
        let subjectsData = [];
        
        // --- MODO OSCURO ---
        const themeBtnIcon = document.getElementById('theme-icon');
        
        window.toggleDarkMode = () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                localStorage.setItem('theme', 'light');
                themeBtnIcon.setAttribute('data-lucide', 'moon');
            } else {
                html.classList.add('dark');
                html.classList.remove('light');
                localStorage.setItem('theme', 'dark');
                themeBtnIcon.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        };

        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            setTimeout(() => themeBtnIcon && themeBtnIcon.setAttribute('data-lucide', 'sun'), 100);
        }

        // --- AUTHENTICATION MEJORADA ---
        const loginScreen = document.getElementById('login-screen');
        const userAvatar = document.getElementById('user-avatar');
        const userInitial = document.getElementById('user-initial');
        const userNameDisplay = document.getElementById('user-name-display');

        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Error:", error);
                
                let errorMsg = 'Revisa tu configuración de Firebase.';
                let errorTitle = 'Error de acceso';

                // Detectar error por ejecutar en archivo local (file://)
                if (error.code === 'auth/operation-not-supported-in-this-environment' || window.location.protocol === 'file:') {
                    errorTitle = 'Entorno no seguro';
                    errorMsg = 'Google no permite iniciar sesión desde un archivo local (file://). <br><br><b>Solución:</b> Usa "Live Server" en VS Code o pulsa "Continuar como Invitado".';
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorTitle = 'Dominio no autorizado';
                    errorMsg = 'Agrega "localhost" o tu dominio en Firebase Console > Authentication > Settings > Authorized Domains.';
                }

                Swal.fire({
                    icon: 'error',
                    title: errorTitle,
                    html: errorMsg,
                    confirmButtonText: 'Entendido'
                });
            }
        };

        // Nueva función para respaldo
        window.loginGuest = async () => {
             try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'Error', text: 'Verifica tu API Key en el código.' });
            }
        };

        window.logout = () => {
            signOut(auth).then(() => {
                subjectsData = [];
                renderApp();
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                
                if (user.isAnonymous) {
                    userInitial.innerText = "I";
                    userAvatar.classList.add('hidden');
                    userInitial.classList.remove('hidden');
                    userNameDisplay.innerText = "Invitado";
                } else if (user.photoURL) {
                    userAvatar.src = user.photoURL;
                    userAvatar.classList.remove('hidden');
                    userInitial.classList.add('hidden');
                    userNameDisplay.innerText = user.displayName || user.email;
                } else {
                    userInitial.innerText = (user.email || "U")[0].toUpperCase();
                    userAvatar.classList.add('hidden');
                    userInitial.classList.remove('hidden');
                    userNameDisplay.innerText = user.displayName || user.email;
                }

                subscribeToData();
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
            }
        });

        // --- DATA & LOGIC ---
        function subscribeToData() {
            if (!currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'grade_data', 'semester_pro_v1');

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    subjectsData = docSnap.data().subjects || [];
                } else {
                    subjectsData = [
                        { id: 1, name: "Matemáticas", units: 3, grades: [null, null, null] }
                    ];
                    saveData(true);
                }
                renderApp();
            }, (error) => {
                console.error("Firestore Error:", error);
                if (error.code === 'permission-denied') {
                     Swal.fire({ icon: 'error', title: 'Permiso denegado', text: 'Revisa las Reglas de Seguridad en Firebase Firestore.' });
                }
            });
        }

        const grid = document.getElementById('subjects-grid');
        const semesterAvgDisplay = document.getElementById('semester-average');
        const semCircle = document.getElementById('sem-circle');
        const semesterStatus = document.getElementById('semester-status');

        function renderApp() {
            grid.innerHTML = '';

            if (subjectsData.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-16 text-slate-400 dark:text-slate-500">
                        <i data-lucide="ghost" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                        <h3 class="text-lg font-medium mb-1">Nada por aquí</h3>
                        <p class="text-sm">Agrega tu primera materia.</p>
                    </div>`;
                updateSemesterAverage();
                lucide.createIcons();
                return;
            }

            subjectsData.forEach((subject, index) => {
                const filledGrades = subject.grades.filter(g => g !== null && g !== "");
                const sum = filledGrades.reduce((a, b) => a + Number(b), 0);
                const currentAvg = filledGrades.length > 0 ? (sum / filledGrades.length).toFixed(1) : "--";
                
                const avgNum = parseFloat(currentAvg);
                let avgColorClass = "text-slate-400";
                let borderColorClass = "border-l-4 border-l-slate-300 dark:border-l-slate-600";
                
                if (!isNaN(avgNum)) {
                    if (avgNum >= 90) { avgColorClass = "text-emerald-500"; borderColorClass = "border-l-4 border-l-emerald-500"; }
                    else if (avgNum >= 80) { avgColorClass = "text-indigo-500"; borderColorClass = "border-l-4 border-l-indigo-500"; }
                    else if (avgNum >= 70) { avgColorClass = "text-amber-500"; borderColorClass = "border-l-4 border-l-amber-500"; }
                    else { avgColorClass = "text-rose-500"; borderColorClass = "border-l-4 border-l-rose-500"; }
                }

                // Calculadora de Salvación
                let salvationMessage = "";
                const remainingUnits = subject.units - filledGrades.length;
                
                if (remainingUnits > 0 && filledGrades.length > 0) {
                    const totalUnits = subject.units;
                    const calculateNeeded = (target) => {
                        const neededTotal = target * totalUnits;
                        const neededRemaining = neededTotal - sum;
                        return (neededRemaining / remainingUnits).toFixed(1);
                    };

                    const needFor70 = calculateNeeded(70);
                    
                    if (avgNum < 70) {
                        if (needFor70 > 100) salvationMessage = `<span class="text-rose-500 font-medium text-xs">⚠️ Matemáticamente imposible pasar con 70.</span>`;
                        else if (needFor70 < 0) salvationMessage = `<span class="text-emerald-500 font-medium text-xs">¡Ya pasaste! (Matemáticamente)</span>`;
                        else salvationMessage = `<span class="text-slate-500 dark:text-slate-400 text-xs">Necesitas <strong class="text-indigo-600 dark:text-indigo-400">${needFor70}</strong> para pasar con 70.</span>`;
                    } else {
                        const needFor90 = calculateNeeded(90);
                        if (needFor90 <= 100) salvationMessage = `<span class="text-emerald-600 dark:text-emerald-400 text-xs">Promedia <strong>${needFor90}</strong> para el 90.</span>`;
                        else salvationMessage = `<span class="text-slate-400 text-xs">Mantén el ritmo.</span>`;
                    }
                } else if (remainingUnits === subject.units) {
                    salvationMessage = `<span class="text-slate-300 dark:text-slate-600 text-xs italic">Agrega notas...</span>`;
                } else {
                    salvationMessage = `<span class="text-slate-400 text-xs font-medium">Finalizado.</span>`;
                }

                const card = document.createElement('div');
                card.className = `bg-white dark:bg-dark-card rounded-xl shadow-sm border border-slate-200 dark:border-dark-border overflow-hidden fade-in flex flex-col transition-colors duration-300 ${borderColorClass}`;

                card.innerHTML = `
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700/50 flex justify-between items-start gap-2">
                        <div class="flex-1">
                            <input 
                                type="text" 
                                value="${subject.name}" 
                                class="w-full bg-transparent font-bold text-lg text-slate-800 dark:text-white border-b border-transparent focus:border-indigo-400 focus:outline-none transition-colors placeholder-slate-400"
                                placeholder="Materia"
                                onchange="window.updateSubjectName(${index}, this.value)"
                            />
                            <div class="flex items-center gap-3 mt-1">
                                <div class="text-xs text-slate-400 flex items-center gap-1">
                                    <i data-lucide="layers" class="w-3 h-3"></i>
                                    <input 
                                        type="number" min="1" max="10" value="${subject.units}" 
                                        class="w-8 text-center bg-transparent border-b border-slate-200 dark:border-slate-600 focus:border-indigo-500 focus:outline-none text-slate-600 dark:text-slate-300"
                                        onchange="window.updateUnitCount(${index}, this.value)"
                                    />
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="window.clearSubjectGrades(${index})" class="p-1.5 text-slate-300 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-900/20 rounded-lg transition-colors" title="Limpiar">
                                <i data-lucide="eraser" class="w-4 h-4"></i>
                            </button>
                            <button onclick="window.removeSubject(${index})" class="p-1.5 text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-lg transition-colors" title="Eliminar">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-5">
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            ${subject.grades.map((grade, gIndex) => {
                                const gVal = grade !== null ? grade : 0;
                                let barColor = "bg-slate-200 dark:bg-slate-700";
                                if(grade !== null) {
                                    if(gVal >= 90) barColor = "bg-emerald-500";
                                    else if(gVal >= 70) barColor = "bg-amber-500";
                                    else barColor = "bg-rose-500";
                                }

                                return `
                                <div class="flex flex-col gap-1 relative group">
                                    <label class="text-[10px] uppercase font-bold text-slate-400 text-center">U${gIndex + 1}</label>
                                    <input 
                                        type="number" min="0" max="100" step="1" placeholder="-" value="${grade !== null ? grade : ''}" 
                                        class="grade-input w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg py-2 px-1 text-center font-bold text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                                        onchange="window.updateGrade(${index}, ${gIndex}, this.value)"
                                    />
                                    <div class="h-1 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden mt-1">
                                        <div class="${barColor} h-full transition-all duration-500" style="width: ${grade !== null ? Math.min(grade, 100) : 0}%"></div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700/50 flex items-end justify-between">
                            <div class="max-w-[70%]">
                                ${salvationMessage}
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] font-semibold text-slate-400 uppercase tracking-wide block mb-1">Promedio</span>
                                <span class="text-3xl font-bold ${avgColorClass}">${currentAvg}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            updateSemesterAverage();
            lucide.createIcons();
        }

        function updateSemesterAverage() {
            let totalSubjectAvgs = 0;
            let subjectsWithGrades = 0;

            subjectsData.forEach(sub => {
                const filled = sub.grades.filter(g => g !== null && g !== "");
                if (filled.length > 0) {
                    totalSubjectAvgs += (filled.reduce((a, b) => a + Number(b), 0) / filled.length);
                    subjectsWithGrades++;
                }
            });

            if (subjectsWithGrades > 0) {
                const semAvg = (totalSubjectAvgs / subjectsWithGrades).toFixed(1);
                semesterAvgDisplay.innerText = semAvg;
                
                const circumference = 226;
                const offset = circumference - ((semAvg / 100) * circumference);
                semCircle.style.strokeDashoffset = offset;

                semCircle.classList.remove('text-emerald-500', 'text-indigo-500', 'text-amber-500', 'text-rose-500');
                
                if (semAvg >= 90) { semCircle.classList.add('text-emerald-500'); semesterStatus.innerText = "¡Excelente!"; semesterStatus.className = "text-sm font-medium text-emerald-500"; }
                else if (semAvg >= 80) { semCircle.classList.add('text-indigo-500'); semesterStatus.innerText = "Muy Bien"; semesterStatus.className = "text-sm font-medium text-indigo-500"; }
                else if (semAvg >= 70) { semCircle.classList.add('text-amber-500'); semesterStatus.innerText = "Regular"; semesterStatus.className = "text-sm font-medium text-amber-500"; }
                else { semCircle.classList.add('text-rose-500'); semesterStatus.innerText = "En Riesgo"; semesterStatus.className = "text-sm font-medium text-rose-500"; }

            } else {
                semesterAvgDisplay.innerText = "--";
                semCircle.style.strokeDashoffset = 226;
                semesterStatus.innerText = "Sin datos";
                semesterStatus.className = "text-sm font-medium text-slate-400";
            }
        }

        let saveTimeout;
        function saveData(immediate = false) {
            if (!currentUser) return;
            const doSave = async () => {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'grade_data', 'semester_pro_v1');
                try {
                    await setDoc(docRef, { subjects: subjectsData }, { merge: true });
                } catch (e) {
                    console.error("Save error", e);
                }
            };
            if (immediate) doSave();
            else { clearTimeout(saveTimeout); saveTimeout = setTimeout(doSave, 1000); }
        }

        // --- Funciones Globales ---

        window.updateGrade = (subIndex, unitIndex, value) => {
            const val = value === "" ? null : parseFloat(value);
            if (val > 100) {
                Swal.fire({ icon: 'warning', title: '¡Calificación alta!', text: 'El máximo suele ser 100.', timer: 2000, showConfirmButton: false });
            }
            subjectsData[subIndex].grades[unitIndex] = val;
            renderApp();
            saveData();
        };

        window.clearSubjectGrades = (index) => {
            Swal.fire({
                title: '¿Limpiar?',
                text: `Se borrarán notas de "${subjectsData[index].name}".`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: 'Sí, limpiar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const length = subjectsData[index].grades.length;
                    subjectsData[index].grades = new Array(length).fill(null);
                    renderApp();
                    saveData();
                }
            });
        };

        window.updateUnitCount = (subIndex, countStr) => {
            let count = parseInt(countStr);
            if (isNaN(count) || count < 1) count = 1;
            if (count > 10) count = 10;
            const currentGrades = subjectsData[subIndex].grades;
            if (count < currentGrades.length) {
                Swal.fire({
                    title: '¿Reducir unidades?',
                    text: "Se perderán calificaciones.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí'
                }).then((result) => {
                    if (result.isConfirmed) {
                        subjectsData[subIndex].grades = currentGrades.slice(0, count);
                        subjectsData[subIndex].units = count;
                        renderApp();
                        saveData();
                    } else { renderApp(); }
                });
            } else {
                if (count > currentGrades.length) {
                    const added = new Array(count - currentGrades.length).fill(null);
                    subjectsData[subIndex].grades = [...currentGrades, ...added];
                }
                subjectsData[subIndex].units = count;
                renderApp();
                saveData();
            }
        };

        window.updateSubjectName = (subIndex, newName) => {
            subjectsData[subIndex].name = newName;
            saveData();
        };

        window.addNewSubject = () => {
            subjectsData.push({ id: Date.now(), name: "Nueva Materia", units: 3, grades: [null, null, null] });
            renderApp();
            saveData();
        };

        window.clearAllData = () => {
            Swal.fire({
                title: '¿Reiniciar?',
                text: "Se borrará todo.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, borrar',
                confirmButtonColor: '#ef4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    subjectsData = [];
                    renderApp();
                    saveData(true);
                }
            });
        };

        window.removeSubject = (index) => {
            Swal.fire({
                title: '¿Eliminar?',
                text: `Se borrará "${subjectsData[index].name}".`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                confirmButtonColor: '#ef4444'
            }).then((result) => {
                if (result.isConfirmed) {
                    subjectsData.splice(index, 1);
                    renderApp();
                    saveData();
                }
            });
        };

        window.exportToImage = () => {
            Swal.fire({ title: 'Generando...', didOpen: () => Swal.showLoading() });
            html2canvas(document.querySelector("main"), {
                backgroundColor: document.documentElement.classList.contains('dark') ? '#0f172a' : '#f8fafc',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Mis_Calificaciones.png';
                link.href = canvas.toDataURL();
                link.click();
                Swal.close();
            });
        };

    </script>
</body>
</html>